<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book to GitHub Issue</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #24292e; --accent: #2ea44f; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background: #f6f8fa; color: var(--primary); }
        h1 { font-size: 1.4rem; margin-bottom: 20px; }
        #reader { width: 100%; max-width: 500px; border: none; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 24px rgba(149, 157, 165, 0.2); background: white; }
        .info { margin-top: 25px; padding: 20px; background: white; border-radius: 12px; width: 85%; max-width: 460px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; background: #e1e4e8; font-size: 0.8rem; font-weight: bold; }
        #loading { display: none; margin-top: 10px; color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <h1>ğŸ“š Book to GitHub</h1>
    
    <div id="reader"></div>

    <div id="loading">æ›¸ç±æƒ…å ±ã‚’ç…§ä¼šä¸­...</div>

    <div class="info">
        <div><strong>æŠ•ç¨¿å…ˆãƒªãƒã‚¸ãƒˆãƒª:</strong></div>
        <div id="target-info" style="margin-top:5px; color:#586069;">å–å¾—ä¸­...</div>
    </div>

    <script>
        // 1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾— (?user=xxx&repo=yyy)
        const params = new URLSearchParams(window.location.search);
        const user = params.get('user');
        const repo = params.get('repo');
        const targetInfo = document.getElementById('target-info');
        const loadingDoc = document.getElementById('loading');

        if (!user || !repo) {
            targetInfo.innerHTML = '<span style="color:#cb2431;">âš ï¸ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(?user=...&repo=...)ãŒå¿…è¦ã§ã™</span>';
        } else {
            targetInfo.innerHTML = `<span class="status-badge">${user} / ${repo}</span>`;
        }

        // 2. ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
        async function onScanSuccess(isbn, decodedResult) {
            // é‡è¤‡å‹•ä½œé˜²æ­¢ã®ãŸã‚ä¸€æ—¦åœæ­¢
            html5QrcodeScanner.clear();
            loadingDoc.style.display = 'block';

            let bookTitle = `ISBN: ${isbn}`; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒˆãƒ«
            
            try {
                // openBD APIã§æ›¸ç±æƒ…å ±ã‚’å–å¾—
                const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
                const data = await res.json();
                
                if (data && data[0] && data[0].summary) {
                    bookTitle = data[0].summary.title;
                }
            } catch (e) {
                console.error("æ›¸ç±æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }

            // GitHub Issueç”¨ã®URLã‚’æ§‹ç¯‰
            const amazonUrl = `https://www.amazon.co.jp/dp/${isbn}`;
            const encodedTitle = encodeURIComponent(`[èª­æ›¸] ${bookTitle}`);
            const encodedBody = encodeURIComponent(`## æ›¸ç±æƒ…å ±\n- ã‚¿ã‚¤ãƒˆãƒ«: ${bookTitle}\n- ISBN: ${isbn}\n- Amazon: ${amazonUrl}\n\n---\n*Captured by Book-to-Issue Tool*`);

            const githubUrl = `https://github.com/${user}/${repo}/issues/new?title=${encodedTitle}&body=${encodedBody}`;

            // æœ€çµ‚ç¢ºèªã—ã¦ã‚¸ãƒ£ãƒ³ãƒ—
            if (confirm(`ã€Œ${bookTitle}ã€ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                window.location.href = githubUrl;
            } else {
                location.reload(); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯å†èª­ã¿è¾¼ã¿
            }
        }

        // 3. ã‚¹ã‚­ãƒ£ãƒŠãƒ¼è¨­å®š
        const html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: { width: 28
