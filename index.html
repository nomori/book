<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book to GitHub Issue</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background: #f4f4f9; }
        #reader { width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .info { margin-top: 20px; padding: 15px; background: white; border-radius: 8px; width: 90%; max-width: 470px; }
        h1 { font-size: 1.2rem; color: #333; }
        code { background: #eee; padding: 2px 4px; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>ğŸ“š Book to GitHub Issue</h1>
    
    <div id="reader"></div>

    <div class="info">
        <p><strong>æŠ•ç¨¿å…ˆ:</strong> <span id="target-info">å–å¾—ä¸­...</span></p>
        <p><small>URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ <code>?user=xxx&repo=yyy</code> ã§å®›å…ˆã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</small></p>
    </div>

    <script>
        // 1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒªãƒã‚¸ãƒˆãƒªåã‚’å–å¾—
        const params = new URLSearchParams(window.location.search);
        const user = params.get('user');
        const repo = params.get('repo');
        const targetInfo = document.getElementById('target-info');

        if (!user || !repo) {
            targetInfo.innerHTML = '<span style="color:red;">ã‚¨ãƒ©ãƒ¼: user ã¾ãŸã¯ repo ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</span>';
        } else {
            targetInfo.innerText = `${user} / ${repo}`;
        }

        // 2. ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚ã®å‡¦ç†
async function onScanSuccess(isbn, decodedResult) {
            // é‡è¤‡å‹•ä½œé˜²æ­¢ã®ãŸã‚ä¸€æ—¦åœæ­¢
            html5QrcodeScanner.clear();
            loadingDoc.style.display = 'block';

            let bookTitle = `ISBN: ${isbn}`; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒˆãƒ«
            
            try {
                // openBD APIã§æ›¸ç±æƒ…å ±ã‚’å–å¾—
                const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
                const data = await res.json();
                
                if (data && data[0] && data[0].summary) {
                    bookTitle = data[0].summary.title;
                }
            } catch (e) {
                console.error("æ›¸ç±æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }

            // GitHub Issueç”¨ã®URLã‚’æ§‹ç¯‰
            const amazonUrl = `https://www.amazon.co.jp/dp/${isbn}`;
            const encodedTitle = encodeURIComponent(`[èª­æ›¸] ${bookTitle}`);
            const encodedBody = encodeURIComponent(`## æ›¸ç±æƒ…å ±\n- ã‚¿ã‚¤ãƒˆãƒ«: ${bookTitle}\n- ISBN: ${isbn}\n- Amazon: ${amazonUrl}\n\n---\n*Captured by Book-to-Issue Tool*`);

            const githubUrl = `https://github.com/${user}/${repo}/issues/new?title=${encodedTitle}&body=${encodedBody}`;

            // æœ€çµ‚ç¢ºèªã—ã¦ã‚¸ãƒ£ãƒ³ãƒ—
            if (confirm(`ã€Œ${bookTitle}ã€ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                window.location.href = githubUrl;
            } else {
                location.reload(); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯å†èª­ã¿è¾¼ã¿
            }
        }

        // 3. ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®èµ·å‹•
        const html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: {width: 250, height: 150} }
        );
        html5QrcodeScanner.render(onScanSuccess);
    </script>
</body>
</html>
